<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monopoly ‚Äî Tablero Integrado con API</title>

  <!-- Tailwind CDN para prototipos -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- CSS espec√≠fico del tablero -->
  <style>
    /* Estilos del tablero Monopoly - Versi√≥n integrada con API */

    .tablero {
      aspect-ratio: 1/1;
      max-width: 900px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(180deg, #f8fafc, #eef2ff);
      box-shadow: 0 8px 30px rgba(16, 24, 40, 0.12);
    }

    .casilla {
      border: 1px solid rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      user-select: none;
      position: relative;
      padding: 4px;
      min-height: 60px;
      background: white;
    }

    .casilla.esquina {
      font-weight: 700;
      font-size: 0.8rem;
      min-height: 80px;
    }

    .casilla.especial {
      font-weight: bold;
      text-align: center;
    }

    .casilla.propiedad {
      border-top-width: 8px;
      border-top-style: solid;
    }

    .casilla.ferrocarril {
      font-weight: bold;
    }

    .casilla.impuesto {
      font-weight: bold;
      text-align: center;
    }

    .casilla.carta {
      font-weight: bold;
      text-align: center;
    }

    .casilla-nombre {
      text-align: center;
      line-height: 1.1;
      font-size: 0.65rem;
      font-weight: 500;
    }

    .precio {
      font-size: 0.6rem;
      font-weight: bold;
      margin-top: 2px;
      color: #374151;
    }

    .impuesto-valor {
      font-size: 0.6rem;
      font-weight: bold;
      margin-top: 2px;
    }

    .ficha {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      transition: transform 400ms ease, opacity 300ms;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(2, 6, 23, 0.18);
      z-index: 10;
      border: 2px solid white;
    }

    .ficha-mini {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: 0 1px 3px rgba(2, 6, 23, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .nombre-ficha {
      position: absolute;
      top: 34px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      white-space: nowrap;
      background: rgba(255, 255, 255, 0.95);
      padding: 1px 4px;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(2, 6, 23, 0.08);
      z-index: 9;
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controles {
      max-width: 900px;
      margin: 18px auto;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .dados {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.05rem;
    }

    .lista-jugadores {
      max-width: 900px;
      margin: 0 auto;
    }

    .lista-jugadores ul {
      max-height: 300px;
      overflow-y: auto;
    }

    .lista-jugadores li {
      transition: background-color 200ms ease;
    }

    .lista-jugadores li:hover {
      background-color: #f1f5f9 !important;
    }

    /* Estilos espec√≠ficos para tipos de casilla */
    .casilla[data-posicion-monopoly="0"] {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      font-weight: bold;
    }

    .casilla[data-posicion-monopoly="10"] {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      font-weight: bold;
    }

    .casilla[data-posicion-monopoly="20"] {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      font-weight: bold;
    }

    .casilla[data-posicion-monopoly="30"] {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      font-weight: bold;
    }

    /* Animaciones para las fichas */
    @keyframes mover-ficha {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .ficha.moviendo {
      animation: mover-ficha 0.5s ease-in-out;
    }

    /* Estilos para el registro de actividades */
    #registro {
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #registro div {
      padding: 4px 0;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.85rem;
      color: #475569;
    }

    #registro div:last-child {
      border-bottom: none;
    }

    #registro div:first-child {
      font-weight: 600;
      color: #1e293b;
    }

    /* Status de conexi√≥n API */
    .api-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      z-index: 1000;
    }

    .api-status.conectado {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .api-status.desconectado {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .tablero {
        max-width: 100%;
        margin: 0 auto;
      }
      
      .casilla {
        font-size: 0.6rem;
        padding: 2px;
        min-height: 45px;
      }
      
      .casilla-nombre {
        font-size: 0.55rem;
      }
      
      .precio, .impuesto-valor {
        font-size: 0.5rem;
      }
      
      .ficha {
        width: 20px;
        height: 20px;
        font-size: 12px;
      }
      
      .nombre-ficha {
        font-size: 8px;
        top: 24px;
      }
      
      .controles {
        flex-direction: column;
        gap: 8px;
      }
    }

    @media (max-width: 480px) {
      .casilla {
        font-size: 0.5rem;
        min-height: 35px;
      }
      
      .casilla-nombre {
        font-size: 0.45rem;
      }
      
      .ficha {
        width: 16px;
        height: 16px;
        font-size: 10px;
      }
      
      .nombre-ficha {
        display: none; /* Ocultar nombres en pantallas muy peque√±as */
      }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen p-6">

  <!-- Status de API -->
  <div id="api-status" class="api-status desconectado">
    üî¥ API Desconectada
  </div>

  <header class="max-w-4xl mx-auto mb-6">
    <h1 class="text-3xl font-extrabold">üé≤ Monopoly ‚Äî Tablero Integrado</h1>
    <p class="text-sm text-slate-600">Conectado con la API del profesor - Versi√≥n completa con todas las funcionalidades.</p>
    <div class="mt-2 text-xs text-slate-500">
      <span>API: http://127.0.0.1:5000</span> |
      <span id="total-jugadores">Jugadores: 0</span> |
      <span id="turno-actual">Turno: ‚Äî</span>
    </div>
  </header>

  <!-- tablero -->
  <main class="tablero grid grid-cols-11 grid-rows-11 gap-0" id="tablero">
    <!-- Se generan 121 casillas con JS -->
  </main>

  <!-- controles -->
  <div class="controles">
    <button id="btn-tirar" class="px-4 py-2 bg-indigo-600 text-white rounded shadow hover:bg-indigo-700 disabled:opacity-50">
      üé≤ Tirar dados
    </button>
    <div id="mostrar-dados" class="dados bg-white rounded border shadow">-</div>
    <button id="btn-terminar-turno" class="px-4 py-2 bg-slate-200 rounded hover:bg-slate-300">
      ‚è≠Ô∏è Terminar turno
    </button>
    <div id="jugador-actual" class="px-3 py-2 bg-white rounded shadow text-sm font-medium">
      Jugador: ‚Äî
    </div>
  </div>

  <!-- lista de jugadores -->
  <section class="lista-jugadores mt-4 max-w-4xl mx-auto">
    <div class="bg-white rounded-lg p-4 shadow">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-lg">üë• Jugadores</h2>
        <div class="flex gap-2">
          <button onclick="window._monopoly?.mostrarEstado()" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">
            üîç Debug
          </button>
          <button onclick="cargarJugadoresManual()" class="text-xs bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded">
            üîÑ Recargar Jugadores
          </button>
        </div>
      </div>
      <ul id="lista-jugadores-ul" class="space-y-2"></ul>
    </div>
  </section>

  <!-- Informaci√≥n de la API -->
  <section class="max-w-4xl mx-auto mt-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white rounded p-4 shadow">
        <h3 class="font-semibold text-sm text-gray-600 mb-2">üìä Tablero</h3>
        <div id="info-tablero" class="text-xs text-gray-500">
          Cargando...
        </div>
      </div>
      <div class="bg-white rounded p-4 shadow">
        <h3 class="font-semibold text-sm text-gray-600 mb-2">üåç Pa√≠ses</h3>
        <div id="info-paises" class="text-xs text-gray-500">
          Cargando...
        </div>
      </div>
      <div class="bg-white rounded p-4 shadow">
        <h3 class="font-semibold text-sm text-gray-600 mb-2">üèÜ Ranking</h3>
        <div id="info-ranking" class="text-xs text-gray-500">
          Cargando...
        </div>
      </div>
    </div>
  </section>

  <!-- logs -->
  <div class="max-w-4xl mx-auto mt-4">
    <div class="bg-white rounded-lg p-4 shadow">
      <h3 class="font-semibold text-sm text-gray-600 mb-2">üìù Registro de Actividades</h3>
      <div id="registro" class="text-sm text-slate-600"></div>
    </div>
  </div>

  <!-- Script del tablero integrado -->
  <script>
    // public/scripts/tablero.js
    document.addEventListener("DOMContentLoaded", () => {
      // Cambiar a la API del profesor
      const API_BASE = "http://127.0.0.1:5000";
      const ENDPOINTS = {
        board: `${API_BASE}/board`,
        countries: `${API_BASE}/countries`,
        ranking: `${API_BASE}/ranking`,
        scoreRecorder: `${API_BASE}/score-recorder`
      };

      // construir 11x11 casillas
      const tablero = document.getElementById("tablero");
      if (tablero) {
        let html = "";
        for (let fila = 0; fila < 11; fila++) {
          for (let columna = 0; columna < 11; columna++) {
            const indice = fila * 11 + columna;
            html += `<div id="casilla-${indice}" class="casilla" data-fila="${fila}" data-columna="${columna}" data-posicion-monopoly="-1"></div>`;
          }
        }
        tablero.innerHTML = html;
      }

      // Elementos UI
      const btnTirar = document.getElementById("btn-tirar");
      const mostrarDados = document.getElementById("mostrar-dados");
      const listaJugadoresUL = document.getElementById("lista-jugadores-ul");
      const jugadorActualDiv = document.getElementById("jugador-actual");
      const registroDiv = document.getElementById("registro");
      const apiStatusDiv = document.getElementById("api-status");

      // Estado del juego
      let jugadores = [];
      let orden = [];
      let indiceTurno = 0;
      let posiciones = {};
      let tableroData = null;
      let paisesData = null;
      let propiedadesJugadores = {}; // Para rastrear propiedades de cada jugador
      const TOTAL_CASILLAS = 40;

      // funciones auxiliares
      async function peticionSegura(url, opciones = {}) {
        try {
          console.log(`Haciendo petici√≥n a: ${url}`);
          const respuesta = await fetch(url, opciones);
          const datos = await respuesta.json();
          if (!respuesta.ok) throw new Error(datos.message || `Error ${respuesta.status}: ${respuesta.statusText}`);
          console.log(`Respuesta exitosa de ${url}:`, datos);
          
          // Actualizar status de API
          if (apiStatusDiv) {
            apiStatusDiv.textContent = "üü¢ API Conectada";
            apiStatusDiv.className = "api-status conectado";
          }
          
          return datos;
        } catch (error) {
          console.error("Error en peticionSegura:", error);
          agregarRegistro("‚ö†Ô∏è " + error.message);
          
          // Actualizar status de API
          if (apiStatusDiv) {
            apiStatusDiv.textContent = "üî¥ API Desconectada";
            apiStatusDiv.className = "api-status desconectado";
          }
          
          return null;
        }
      }

      function agregarRegistro(texto) {
        if (!registroDiv) return;
        const elemento = document.createElement("div");
        elemento.textContent = `[${new Date().toLocaleTimeString()}] ${texto}`;
        registroDiv.prepend(elemento);
      }

      // Cargar datos del tablero desde la API
      async function cargarTablero() {
        const datos = await peticionSegura(ENDPOINTS.board);
        if (datos) {
          tableroData = datos;
          agregarRegistro("Tablero cargado desde la API");
          aplicarDatosTablero();
          actualizarInfoTablero();
        }
        return datos;
      }

      // Cargar pa√≠ses desde la API
      async function cargarPaises() {
        const datos = await peticionSegura(ENDPOINTS.countries);
        if (datos) {
          paisesData = datos;
          agregarRegistro("Pa√≠ses cargados desde la API");
          actualizarInfoPaises();
        }
        return datos;
      }

      // Aplicar los datos del tablero a las casillas
      function aplicarDatosTablero() {
        if (!tableroData) return;
        
        // Limpiar casillas existentes
        document.querySelectorAll('.casilla').forEach(casilla => {
          casilla.classList.remove('esquina', 'propiedad', 'especial', 'impuesto', 'ferrocarril', 'carta');
          casilla.innerHTML = '';
          casilla.style.backgroundColor = '';
        });

        // Obtener todas las casillas del tablero en orden
        const todasLasCasillas = [
          ...tableroData.bottom,
          ...tableroData.left.slice(1), // Omitir la primera porque es la esquina que ya est√° en bottom
          ...tableroData.top.reverse(),
          ...tableroData.right.slice(1).reverse() // Omitir la primera porque es la esquina que ya est√° en top
        ];

        // Aplicar datos a cada casilla
        todasLasCasillas.forEach((casilla, posicionMonopoly) => {
          const idCasillaDOM = mapearPosicionACasillaId(posicionMonopoly);
          const elemento = document.getElementById(idCasillaDOM);
          if (!elemento) return;

          // Guardar la posici√≥n del Monopoly en el elemento
          elemento.dataset.posicionMonopoly = posicionMonopoly;
          elemento.dataset.casillaId = casilla.id;
          
          // Aplicar nombre y t√≠tulo
          elemento.innerHTML = `<span class="casilla-nombre">${casilla.name}</span>`;
          elemento.title = `${casilla.name} (ID: ${casilla.id})`;

          // Aplicar estilos seg√∫n el tipo
          switch (casilla.type) {
            case 'special':
              elemento.classList.add('esquina', 'especial');
              if (casilla.name.includes('Salida')) {
                elemento.style.backgroundColor = '#10b981';
                elemento.style.color = 'white';
              } else if (casilla.name.includes('C√°rcel')) {
                elemento.style.backgroundColor = '#f59e0b';
              } else if (casilla.name.includes('Parqueo')) {
                elemento.style.backgroundColor = '#ef4444';
                elemento.style.color = 'white';
              } else if (casilla.name.includes('Ve a la C√°rcel')) {
                elemento.style.backgroundColor = '#dc2626';
                elemento.style.color = 'white';
              }
              break;

            case 'property':
              elemento.classList.add('propiedad');
              elemento.style.borderTop = `8px solid ${obtenerColorPropiedad(casilla.color)}`;
              elemento.innerHTML += `<div class="precio">$${casilla.price}</div>`;
              break;

            case 'railroad':
              elemento.classList.add('ferrocarril');
              elemento.style.backgroundColor = '#374151';
              elemento.style.color = 'white';
              elemento.innerHTML += `<div class="precio">$${casilla.price}</div>`;
              break;

            case 'tax':
              elemento.classList.add('impuesto');
              elemento.style.backgroundColor = '#fbbf24';
              elemento.innerHTML += `<div class="impuesto-valor">$${Math.abs(casilla.action.money)}</div>`;
              break;

            case 'community_chest':
              elemento.classList.add('carta');
              elemento.style.backgroundColor = '#8b5cf6';
              elemento.style.color = 'white';
              break;

            case 'chance':
              elemento.classList.add('carta');
              elemento.style.backgroundColor = '#f97316';
              elemento.style.color = 'white';
              break;
          }
        });

        agregarRegistro("Tablero configurado con datos de la API");
      }

      // Obtener color de propiedad
      function obtenerColorPropiedad(color) {
        const colores = {
          'brown': '#8b4513',
          'purple': '#8b5cf6',
          'pink': '#ec4899',
          'orange': '#f97316',
          'red': '#ef4444',
          'yellow': '#fbbf24',
          'green': '#10b981',
          'blue': '#3b82f6'
        };
        return colores[color] || '#6b7280';
      }

      // Cargar jugadores (desde localStorage o inicializar vac√≠o)
      async function cargarJugadores() {
        // Intentar cargar jugadores de localStorage (datos del compa√±ero)
        const jugadoresGuardados = localStorage.getItem('jugadores');
        if (jugadoresGuardados) {
          try {
            jugadores = JSON.parse(jugadoresGuardados);
            agregarRegistro(`Cargados ${jugadores.length} jugadores desde localStorage`);
          } catch (e) {
            console.error("Error al parsear jugadores:", e);
            jugadores = [];
          }
        }

        // Si no hay jugadores, intentar cargar desde una variable global (por si el compa√±ero la usa)
        if (jugadores.length === 0 && window.jugadoresCreados) {
          jugadores = window.jugadoresCreados;
          agregarRegistro(`Cargados ${jugadores.length} jugadores desde variable global`);
        }

        // Si a√∫n no hay jugadores, crear algunos de ejemplo
        if (jugadores.length === 0) {
          jugadores = [
            {
              "id": Date.now(),
              "nombre": "Jugador 1",
              "pais": "Colombia", 
              "ficha": "üöó",
              "color": "botonblue",
              "dinero": 1500
            },
            {
              "id": Date.now() + 1,
              "nombre": "Jugador 2",
              "pais": "Spain (Espa√±a)",
              "ficha": "üêò",
              "color": "botonyellow", 
              "dinero": 1500
            }
          ];
          agregarRegistro("No se encontraron jugadores, usando datos de ejemplo");
        }

        // Ordenar por ID y configurar estado inicial
        jugadores.sort((a, b) => a.id - b.id);
        orden = jugadores.map(jugador => jugador.id);
        jugadores.forEach(jugador => {
          if (posiciones[jugador.id] === undefined) posiciones[jugador.id] = 0;
          if (propiedadesJugadores[jugador.id] === undefined) propiedadesJugadores[jugador.id] = [];
        });

        renderizarJugadores();
        renderizarFichasTablero();
        actualizarUIJugadorActual();
        actualizarContadorJugadores();
      }

      // Funci√≥n para recargar jugadores manualmente
      window.cargarJugadoresManual = async function() {
        // Limpiar datos actuales
        jugadores = [];
        posiciones = {};
        propiedadesJugadores = {};
        
        // Recargar
        await cargarJugadores();
        agregarRegistro("Jugadores recargados manualmente");
      };

      // Cargar ranking desde la API
      async function cargarRanking() {
        const datos = await peticionSegura(ENDPOINTS.ranking);
        if (datos) {
          agregarRegistro("Ranking cargado desde la API");
          console.log("Ranking actual:", datos);
          actualizarInfoRanking(datos);
        }
        return datos;
      }

      // Enviar puntaje a la API
      async function enviarPuntaje(jugador, puntaje) {
        const datos = {
          nick_name: jugador.nombre,
          score: puntaje,
          country_code: obtenerCodigoPais(jugador.pais)
        };

        const resultado = await peticionSegura(ENDPOINTS.scoreRecorder, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(datos)
        });

        if (resultado) {
          agregarRegistro(`Puntaje enviado: ${jugador.nombre} - ${puntaje} puntos`);
        }
        return resultado;
      }

      // Obtener c√≥digo de pa√≠s (mapeo b√°sico)
      function obtenerCodigoPais(pais) {
        const mapeo = {
          'Colombia': 'co',
          'Spain (Espa√±a)': 'es',
          'Espa√±a': 'es',
          'Estados Unidos': 'us',
          'M√©xico': 'mx',
          'Argentina': 'ar',
          'Chile': 'cl',
          'Per√∫': 'pe'
        };
        return mapeo[pais] || 'co';
      }

      // Event listeners y inicializaci√≥n
      if (btnTirar) btnTirar.addEventListener("click", manejarTirarDados);
      const btnTerminar = document.getElementById("btn-terminar-turno");
      if (btnTerminar) btnTerminar.addEventListener("click", terminarTurno);

      // Iniciar aplicaci√≥n
      inicializar();

      // API de debug
      window._monopoly = {
        jugadores, posiciones, orden, propiedadesJugadores, tableroData,
        establecerPos: (id, posicion) => { 
          posiciones[id] = posicion; 
          renderizarFichasTablero(); 
          renderizarJugadores(); 
        },
        mostrarEstado: () => console.log({jugadores, posiciones, propiedadesJugadores})
      };
    });
  </script>
</body>
</html>